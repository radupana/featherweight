name: Build and Test

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Gradle
      run: |
        chmod +x gradlew
        # Gradle optimizations for CI
        mkdir -p ~/.gradle
        echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties
        echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
        echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
        echo "org.gradle.jvmargs=-Xmx3g -XX:+UseParallelGC" >> ~/.gradle/gradle.properties

    - name: Create dummy google-services.json
      run: |
        echo '{
          "project_info": {
            "project_number": "123456789",
            "firebase_url": "https://dummy.firebaseio.com",
            "project_id": "dummy-project",
            "storage_bucket": "dummy-project.appspot.com"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:123456789:android:abcdef",
                "android_client_info": {
                  "package_name": "com.github.radupana.featherweight"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "dummy-key"
                }
              ],
              "services": {}
            }
          ],
          "configuration_version": "1"
        }' > app/google-services.json

    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest || (echo "Test failed. Check test report artifact for details."; exit 1)

    - name: Generate Unit Test Coverage Report
      if: always()
      run: |
        echo "Generating unit test coverage report..."
        ./gradlew createDebugUnitTestCoverageReport || echo "::warning::Failed to generate coverage report"
        if [ -f app/build/reports/coverage/test/debug/index.html ]; then
          echo "::notice title=Coverage Report::Successfully generated unit test coverage report"
          ls -la app/build/reports/coverage/test/debug/ | head -5
        else
          echo "::error::Coverage report index.html not found at expected location"
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: app/build/reports/tests/testDebugUnitTest/

    - name: Upload unit test coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-coverage
        path: app/build/reports/coverage/test/debug/
        if-no-files-found: warn

  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Gradle
      run: |
        chmod +x gradlew
        # Gradle optimizations for CI
        mkdir -p ~/.gradle
        echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties
        echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
        echo "org.gradle.caching=true" >> ~/.gradle/gradle.properties
        echo "org.gradle.jvmargs=-Xmx3g -XX:+UseParallelGC" >> ~/.gradle/gradle.properties

    - name: Create dummy google-services.json
      run: |
        echo '{
          "project_info": {
            "project_number": "123456789",
            "firebase_url": "https://dummy.firebaseio.com",
            "project_id": "dummy-project",
            "storage_bucket": "dummy-project.appspot.com"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:123456789:android:abcdef",
                "android_client_info": {
                  "package_name": "com.github.radupana.featherweight"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "dummy-key"
                }
              ],
              "services": {}
            }
          ],
          "configuration_version": "1"
        }' > app/google-services.json

    - name: Run Lint
      run: ./gradlew lint

    - name: Upload lint results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: app/build/reports/lint-results-debug.html

    - name: Run Detekt
      run: ./gradlew detekt
      continue-on-error: true

    - name: Upload detekt results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: detekt-results
        path: app/build/reports/detekt/
