name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Optional: Override version (e.g., 2.0.0)'
        required: false
        type: string

permissions:
  contents: write  # Required for creating releases
  actions: read    # Required for downloading artifacts

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Create dummy google-services.json
      run: |
        echo '{
          "project_info": {
            "project_number": "123456789",
            "firebase_url": "https://dummy.firebaseio.com",
            "project_id": "dummy-project",
            "storage_bucket": "dummy-project.appspot.com"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:123456789:android:abcdef",
                "android_client_info": {
                  "package_name": "com.github.radupana.featherweight"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "dummy-key"
                }
              ],
              "services": {}
            }
          ],
          "configuration_version": "1"
        }' > app/google-services.json
    
    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest || (echo "Test failed. Check test report artifact for details."; exit 1)
    
    - name: Generate Unit Test Coverage Report
      if: always()
      run: ./gradlew createDebugUnitTestCoverageReport
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: app/build/reports/tests/testDebugUnitTest/
    
    - name: Upload unit test coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-coverage
        path: app/build/reports/coverage/test/debug/
    
    - name: Run Lint
      run: ./gradlew lint
    
    - name: Upload lint results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: app/build/reports/lint-results-debug.html
    
    - name: Run Detekt
      run: ./gradlew detekt
      continue-on-error: true
    
    - name: Upload detekt results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: detekt-results
        path: app/build/reports/detekt/

  ui-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Create dummy google-services.json
      run: |
        echo '{
          "project_info": {
            "project_number": "123456789",
            "firebase_url": "https://dummy.firebaseio.com",
            "project_id": "dummy-project",
            "storage_bucket": "dummy-project.appspot.com"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:123456789:android:abcdef",
                "android_client_info": {
                  "package_name": "com.github.radupana.featherweight"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "dummy-key"
                }
              ],
              "services": {}
            }
          ],
          "configuration_version": "1"
        }' > app/google-services.json
    
    - name: AVD cache
      uses: actions/cache@v4
      id: avd-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
        key: avd-api-29-arm64-${{ runner.os }}
    
    - name: Create AVD and generate snapshot for caching
      if: steps.avd-cache.outputs.cache-hit != 'true'
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        arch: arm64-v8a
        force-avd-creation: false
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: false
        script: echo "Generated AVD snapshot for caching."
    
    - name: Run UI Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        arch: arm64-v8a
        force-avd-creation: false
        emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: true
        script: ./gradlew connectedDebugAndroidTest
    
    - name: Generate UI Test Coverage Report
      if: always()
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        arch: arm64-v8a
        force-avd-creation: false
        emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: true
        script: ./gradlew createDebugAndroidTestCoverageReport
    
    - name: Upload UI test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-results
        path: app/build/reports/androidTests/connected/
    
    - name: Upload UI test coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-coverage
        path: app/build/reports/coverage/androidTest/debug/

  deploy:
    needs: [test, ui-test]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Decode Google Services JSON
      env:
        GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
      run: |
        echo "$GOOGLE_SERVICES_JSON" | base64 -d > app/google-services.json
    
    - name: Decode Keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        echo "$KEYSTORE_BASE64" | base64 -d > app/featherweight-release.keystore
    
    - name: Build Alpha APK
      env:
        KEYSTORE_PATH: ${{ github.workspace }}/app/featherweight-release.keystore
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: ./gradlew assembleAlpha
    
    - name: Extract version from gradle.properties
      id: get_version
      run: |
        if [ -n "${{ github.event.inputs.version_override }}" ]; then
          VERSION="${{ github.event.inputs.version_override }}"
          echo "Using override version: $VERSION"
        else
          VERSION=$(grep "^appVersion=" gradle.properties | cut -d'=' -f2)
          echo "Using gradle.properties version: $VERSION"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Deploying version: $VERSION"
    
    - name: Upload to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1.7.1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        groups: alpha-testers
        releaseNotes: |
          Version: ${{ steps.get_version.outputs.version }}-alpha
          Build: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          
          ğŸ“± This is an ALPHA build with Firebase feedback enabled
          Use the "Feedback" button in the bottom navigation bar
          
          Changes: ${{ github.event.head_commit.message }}
        file: app/build/outputs/apk/alpha/app-alpha.apk
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-alpha
        path: app/build/outputs/apk/alpha/app-alpha.apk

  release:
    needs: [test, ui-test, deploy]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4.1.7
      with:
        path: artifacts
    
    - name: Create reports bundle
      run: |
        mkdir -p reports-bundle
        
        # Create main index HTML
        cat > reports-bundle/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Build Reports - v${{ needs.deploy.outputs.version }} Build ${{ github.run_number }}</title>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; background: #f6f8fa; }
            .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
            h1 { color: #24292e; border-bottom: 1px solid #e1e4e8; padding-bottom: 10px; }
            .info { background: #f1f8ff; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #0366d6; }
            .reports { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
            .report-card { background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 20px; text-align: center; transition: transform 0.2s; }
            .report-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
            .report-card a { text-decoration: none; color: #0366d6; font-weight: 500; }
            .report-card .icon { font-size: 2em; margin-bottom: 10px; }
            .meta { color: #586069; font-size: 14px; margin-top: 20px; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>ğŸš€ Featherweight Build Reports</h1>
            
            <div class="info">
              <strong>Version:</strong> ${{ needs.deploy.outputs.version }}<br>
              <strong>Build:</strong> ${{ github.run_number }}<br>
              <strong>Commit:</strong> ${{ github.sha }}<br>
              <strong>Date:</strong> $(date -u +'%Y-%m-%d %H:%M:%S UTC')<br>
              <strong>Changes:</strong> ${{ github.event.head_commit.message }}
            </div>
            
            <div class="reports">
              <div class="report-card">
                <div class="icon">ğŸ§ª</div>
                <a href="test-results/index.html" target="_blank">Unit Test Results</a>
              </div>
              
              <div class="report-card">
                <div class="icon">ğŸ“Š</div>
                <a href="unit-test-coverage/index.html" target="_blank">Unit Test Coverage</a>
              </div>
              
              <div class="report-card">
                <div class="icon">ğŸ“±</div>
                <a href="ui-test-results/index.html" target="_blank">UI Test Results</a>
              </div>
              
              <div class="report-card">
                <div class="icon">ğŸ“ˆ</div>
                <a href="ui-test-coverage/index.html" target="_blank">UI Test Coverage</a>
              </div>
              
              <div class="report-card">
                <div class="icon">ğŸ”</div>
                <a href="detekt-results/detekt.html" target="_blank">Detekt Analysis</a>
              </div>
              
              <div class="report-card">
                <div class="icon">âœ…</div>
                <a href="lint-results.html" target="_blank">Android Lint</a>
              </div>
            </div>
            
            <div class="meta">
              Generated by GitHub Actions â€¢ Build ${{ github.run_number }}
            </div>
          </div>
        </body>
        </html>
        EOF
        
        # Copy all report files
        cp -r artifacts/test-results/* reports-bundle/ 2>/dev/null || echo "No test results found"
        cp -r artifacts/unit-test-coverage/* reports-bundle/ 2>/dev/null || echo "No unit test coverage found"
        cp -r artifacts/ui-test-results/* reports-bundle/ 2>/dev/null || echo "No UI test results found"
        cp -r artifacts/ui-test-coverage/* reports-bundle/ 2>/dev/null || echo "No UI test coverage found"
        cp -r artifacts/detekt-results/* reports-bundle/ 2>/dev/null || echo "No detekt results found"  
        cp artifacts/lint-results/* reports-bundle/ 2>/dev/null || echo "No lint results found"
        
        # Create zip bundle
        cd reports-bundle && zip -r ../reports-bundle.zip . && cd ..
    
    - name: Extract version for release
      id: release_version
      run: |
        VERSION="${{ needs.deploy.outputs.version }}"
        BUILD_NUMBER="${{ github.run_number }}"
        TAG="v${VERSION}-build${BUILD_NUMBER}"
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "title=v${VERSION} - Build ${BUILD_NUMBER}" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release with Assets
      uses: softprops/action-gh-release@v2.3.2
      with:
        tag_name: ${{ steps.release_version.outputs.tag }}
        name: ${{ steps.release_version.outputs.title }}
        body: |
          ğŸš€ **Build ${{ github.run_number }}** - Version ${{ needs.deploy.outputs.version }}
          
          ğŸ“± **APK**: Ready for testing (also distributed via Firebase App Distribution)
          ğŸ“Š **Reports**: Download and extract reports bundle, then open `index.html` for full dashboard
          
          **Changes**: ${{ github.event.head_commit.message }}
          **Commit**: ${{ github.sha }}
          
          ---
          
          ### ğŸ“‹ Reports Included
          - **Unit Tests**: Complete test results with pass/fail status
          - **Unit Test Coverage**: Code coverage from unit tests  
          - **UI Tests**: Android instrumentation test results
          - **UI Test Coverage**: Code coverage from UI/integration tests
          - **Detekt**: Kotlin code analysis and quality metrics  
          - **Android Lint**: Platform-specific issue detection
        draft: false
        prerelease: false
        files: |
          artifacts/apk-alpha/app-alpha.apk
          reports-bundle.zip
        fail_on_unmatched_files: true